<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Twitch Icons Resizer</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--accent:#06b6d4;--muted:#94a3b8}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,system-ui,Arial;background:linear-gradient(180deg,#08101a 0%, #0f1724 100%);color:#e6eef6}
    .wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:24px}
    .card{background:rgba(255,255,255,0.03);border-radius:12px;padding:28px 32px;box-shadow:0 6px 30px rgba(2,6,23,0.6);max-width:920px;width:100%;text-align:center}
    h1{margin:0 0 8px;font-size:36px}
    p.lead{margin:0 0 18px;color:var(--muted);font-size:14px}
    .big-btn{display:inline-flex;align-items:center;gap:10px;background:linear-gradient(90deg,var(--accent),#8b5cf6);border:none;padding:12px 18px;border-radius:10px;color:black;font-weight:700;cursor:pointer;font-size:15px}
    .hidden-input{display:none}
    .previews{display:flex;gap:18px;justify-content:center;margin-top:22px;flex-wrap:wrap}
    .preview{background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;display:flex;flex-direction:column;align-items:center;gap:8px;width:120px}
    .preview img{width:100px;height:100px;object-fit:contain;border-radius:6px}
    .size-label{font-size:13px;color:var(--muted)}
    .note{margin-top:14px;font-size:13px;color:var(--muted)}
    .checker{background-image:linear-gradient(45deg,#ddd 25%,transparent 25%),linear-gradient(-45deg,#ddd 25%,transparent 25%),linear-gradient(45deg,transparent 75%,#ddd 75%),linear-gradient(-45deg,transparent 75%,#ddd 75%);background-size:16px 16px;background-position:0 0,0 8px,8px -8px, -8px 0}
    .preview .thumb{width:112px;height:112px;display:flex;align-items:center;justify-content:center;border-radius:6px;overflow:hidden}
    a.download-link{display:inline-block;text-decoration:none;margin-top:6px;padding:6px 8px;border-radius:7px;background:rgba(255,255,255,0.03);color:var(--muted);font-size:13px}
    @media (max-width:540px){.preview{width:90px}.preview img{width:70px;height:70px}.preview .thumb{width:84px;height:84px}}

    /* Подсветка при drag-over */
    body.drag-over::before {
      content: "Перетащите изображение сюда";
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(6,182,212,0.15);
      border: 3px dashed var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      font-weight: bold;
      color: var(--accent);
      z-index: 9999;
      pointer-events: none;
    }

    /* === Toggle Crop Switch === */
    .crop-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      cursor: pointer;
      user-select: none;
    }

    .crop-toggle input {
      display: none;
    }

    .crop-toggle .slider {
      width: 40px;
      height: 20px;
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      position: relative;
      transition: 0.25s;
    }

    .crop-toggle .slider::before {
      content: "";
      position: absolute;
      left: 2px;
      top: 2px;
      width: 16px;
      height: 16px;
      background: var(--muted);
      border-radius: 50%;
      transition: 0.25s;
    }

    .crop-toggle input:checked + .slider {
      background: var(--accent);
    }

    .crop-toggle input:checked + .slider::before {
      transform: translateX(20px);
      background: black;
    }

    .crop-toggle .label-text {
      font-size: 14px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Twitch Images Resizer</h1>
      <p class="lead">Нажмите кнопку, перетащите изображение на страницу или просто вставьте изображение из буфера обмена. Оно преобразуется в 3 квадратных изображения: 28x28, 56x56 и 112х112 пикселей - которые принимает Twitch</p>

      <button id="pickBtn" class="big-btn">Выбрать изображение</button>
      <input id="fileInput" class="hidden-input" type="file" accept="image/*">
      
      <br>

      <label class="crop-toggle">
        <input type="checkbox" id="cropToggle">
        <span class="slider"></span>
        <span class="label-text">Обрезать пустую область</span>
      </label>

      <div id="previewArea" class="previews" aria-live="polite"></div>
      <p class="note">Изображения генерируются локально в браузере, без отправки на сервер, в формате PNG с сохранением исходной прозрачности.</p>
      <p class="note">Made by Quantum0 (<a href="https://www.twitch.tv/quantum075" style="color:#06b6d4">Twitch</a>/<a href="https://github.com/Quantum-0" style="color:#06b6d4">Github</a>).</p>
    </div>
  </div>

  <script>
    const SIZES = [112, 56, 28];

    const pickBtn = document.getElementById('pickBtn');
    const fileInput = document.getElementById('fileInput');
    const previewArea = document.getElementById('previewArea');

    pickBtn.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (ev) => {
      const f = ev.target.files && ev.target.files[0];
      if (f) handleFile(f);
      fileInput.value = '';
    });

    // drag&drop с подсветкой
    let dragCounter = 0;
    document.body.addEventListener('dragenter', (e) => {
      dragCounter++;
      document.body.classList.add('drag-over');
    });
    document.body.addEventListener('dragleave', (e) => {
      dragCounter--;
      if (dragCounter <= 0) {
        document.body.classList.remove('drag-over');
        dragCounter = 0;
      }
    });
    document.body.addEventListener('dragover', (e) => {
      e.preventDefault();
    });
    document.body.addEventListener('drop', (e) => {
      e.preventDefault();
      document.body.classList.remove('drag-over');
      dragCounter = 0;
      const f = e.dataTransfer.files && e.dataTransfer.files[0];
      if (f) handleFile(f);
    });

    document.addEventListener('paste', (e) => {
      const items = e.clipboardData.items;
      for (const item of items) {
        if (item.type.startsWith('image/')) {
          const f = item.getAsFile();
          if (f) {
            handleFile(f);
            break;
          }
        }
      }
    });

    async function handleFile(f){
      if (!f.type.startsWith('image/')){
        alert('Пожалуйста, выберите файл изображения.');
        return;
      }
      previewArea.innerHTML = '';
      try {
        const dataUrl = await readFileAsDataURL(f);
        const img = await loadImage(dataUrl);

        let base = img;

        // === Если включен crop, обрезаем прозрачные пиксели ===
        if (document.getElementById('cropToggle').checked) {
          base = cropTransparent(img);
        }

        for (const size of SIZES){
          const url = await resizeImageToSquarePNG(base, size);
          addPreview(url, size);
        }
      } catch (err){
        console.error(err);
        alert('Не удалось обработать изображение.');
      }
    }

    function readFileAsDataURL(file){
      return new Promise((res, rej) => {
        const fr = new FileReader();
        fr.onload = () => res(fr.result);
        fr.onerror = rej;
        fr.readAsDataURL(file);
      });
    }

    function loadImage(dataUrl){
      return new Promise((res, rej) => {
        const i = new Image();
        i.onload = () => res(i);
        i.onerror = rej;
        i.decoding = 'async';
        i.src = dataUrl;
      });
    }

    /* === Автоматическое обрезание прозрачной области === */
    function cropTransparent(img) {
      const tCanvas = document.createElement('canvas');
      const tCtx = tCanvas.getContext('2d');

      tCanvas.width = img.width;
      tCanvas.height = img.height;
      tCtx.drawImage(img, 0, 0);

      const { data, width, height } = tCtx.getImageData(0, 0, img.width, img.height);

      let top = 0, bottom = height - 1, left = 0, right = width - 1;
      let found = false;

      // top
      for (let y = 0; y < height; y++) {
        for (let x = 0; x < width; x++) {
          if (data[(y * width + x) * 4 + 3] !== 0) {
            top = y; found = true; break;
          }
        }
        if (found) break;
      }

      // bottom
      found = false;
      for (let y = height - 1; y >= 0; y--) {
        for (let x = 0; x < width; x++) {
          if (data[(y * width + x) * 4 + 3] !== 0) {
            bottom = y; found = true; break;
          }
        }
        if (found) break;
      }

      // left
      found = false;
      for (let x = 0; x < width; x++) {
        for (let y = 0; y < height; y++) {
          if (data[(y * width + x) * 4 + 3] !== 0) {
            left = x; found = true; break;
          }
        }
        if (found) break;
      }

      // right
      found = false;
      for (let x = width - 1; x >= 0; x--) {
        for (let y = 0; y < height; y++) {
          if (data[(y * width + x) * 4 + 3] !== 0) {
            right = x; found = true; break;
          }
        }
        if (found) break;
      }

      const w = right - left + 1;
      const h = bottom - top + 1;

      const out = document.createElement('canvas');
      out.width = w;
      out.height = h;
      out.getContext('2d').drawImage(tCanvas, left, top, w, h, 0, 0, w, h);

      return out;
    }

    async function resizeImageToSquarePNG(img, targetSize){
      const canvas = document.createElement('canvas');
      canvas.width = targetSize;
      canvas.height = targetSize;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const iw = img.width;
      const ih = img.height;

      const scale = Math.min(targetSize / iw, targetSize / ih);
      const nw = Math.round(iw * scale);
      const nh = Math.round(ih * scale);
      const dx = Math.round((targetSize - nw) / 2);
      const dy = Math.round((targetSize - nh) / 2);

      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, 0, 0, iw, ih, dx, dy, nw, nh);

      return new Promise((resolve) => {
        canvas.toBlob(blob => {
          const url = URL.createObjectURL(blob);
          resolve(url);
        }, 'image/png');
      });
    }

    function addPreview(objectUrl, size){
      const container = document.createElement('div');
      container.className = 'preview';

      const thumbWrap = document.createElement('div');
      thumbWrap.className = 'thumb checker';

      const img = document.createElement('img');
      img.alt = `Preview ${size}x${size}`;
      img.loading = 'lazy';
      img.src = objectUrl;
      img.width = size;
      img.height = size;

      thumbWrap.appendChild(img);
      container.appendChild(thumbWrap);

      const label = document.createElement('div');
      label.className = 'size-label';
      label.textContent = `${size} × ${size}`;
      container.appendChild(label);

      const link = document.createElement('a');
      link.href = objectUrl;
      link.download = `image_${size}x${size}.png`;
      link.className = 'download-link';
      link.textContent = 'Скачать';

      img.style.cursor = 'pointer';
      img.addEventListener('click', () => link.click());

      container.appendChild(link);
      previewArea.appendChild(container);
    }
  </script>
</body>
</html>
